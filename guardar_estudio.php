<?phpheader("Content-Type : application/json" );$response = array();if($_POST["server"] == 'local'){		include("conex.php");}else{		include("conex_remote.php");}include("conexi_remote.php");$link= Conectarse();$link_remote= conectar_remote();if(isset($_GET["pagado"])){	$restante = $_GET["restante"];	$id_orden = $_GET["id_orden"];	$anticipo = $_GET["anticipo"];	$update="UPDATE ordenes SET restante = '0' WHERE id_orden = '$id_orden'";		mysql_query($update,$link) or die("Error en $update: ".mysql_error());		}	include ("funciones_php/edad.php");	$elabora = $_POST["nombre_usuario"];	$folio_actual = $_POST["folio_actual"];	$nombre_paciente = $_POST["nombre_paciente"];	$sexo = isset($_POST["sexo"]) ? $_POST["sexo"] : "";	if(isset($_POST["enviar_consultorio"])){		$modo_entrega = "Enviar a Consultorio";	}else{		$modo_entrega = "Recoger en Laboratorio";	}		$tipo_folio = $_POST["tipo_folio"];	if(isset($_POST["factura"])){		$recibo_honorarios = 1;				//TODO Guardar Datos Fiscales y asociar con id_cliente y id_orden					}else{		$recibo_honorarios = 0;			}	//$modo_entrega = isset($_POST["modo_entrega"]) ? $_POST["modo_entrega"] : "Recoger en Laboratorio";	$arr_fecha_nac_pac = $_POST["fecha_nac_pac"];	$fecha_nac_pac = implode("-",$arr_fecha_nac_pac);	$edad_pac = calculaEdad($fecha_nac_pac);	$tel_paciente = $_POST["tel_paciente"];	$dir_paciente = $_POST["dir_paciente"];	$nombre_doctor = $_POST["nombre_doctor"];	$tel_doc = $_POST["tel_doc"];	$direccion_doctor = $_POST["direccion_doctor"]; 	$estudios = $_POST["estudios"];	//$radiografias = $_POST["radiografias"];	//$trazos_adicionales = $_POST["trazos_adicionales"];	//$periapical = $_POST["periapical"];	$subtotal = $_POST["subtotal"];	$descuento = $_POST["descuento"];	$efectivo = $_POST["efectivo"];	$tarjeta = $_POST["tarjeta"];	$anticipo = $_POST["anticipo"];	$restante = $_POST["restante"];	$importe_total = $_POST["importe_total"];	$importe_total_letra = $_POST["importe_total_letra"];	$fecha_entrega = $_POST["fecha_entrega"];	$sucursal = $_POST["sucursal"];	$medio_pago = $_POST["medio_pago"];	$zona_origen = $_POST["zona_origen"];				if ($nombre_doctor <> ''){		$buscar_doctor = "SELECT * FROM doctores WHERE nombre_doctor = '$nombre_doctor'";		$result_doctor = mysql_query($buscar_doctor,$link);		if($result_doctor){			$response["existe_doctor"] = 1;		}		else{						$response["existe_doctor"] = 0;			$response["mensaje_doctor"] = "Error en $buscar_doctor: ".mysql_error();		}				if(mysql_num_rows($result_doctor)==0){ // Si el doctor no existe Agregarlo			include("clave_doctor.php");			// $id_doctor = clave_doctor($nombre_doctor, $link) or die("Error al obtener clave");			$id_doctor = $_POST["id_doctor"];			$insert_doctor="INSERT INTO doctores			SET id_doctor = '$id_doctor', 			nombre_doctor = '$nombre_doctor',			tel_doctor = '$tel_doc',			zona = '$zona_origen',			dir_doctor= '$direccion_doctor'";			mysql_query($insert_doctor, $link) or die('Error al guardar Doctor: '.mysql_error());		}		else{			while($row = mysql_fetch_assoc($result_doctor)){					$id_doctor = $row["id_doctor"];			}					}	}	//--------------------------	$insert_paciente="INSERT INTO pacientes	SET nombre_paciente = '$nombre_paciente',	sexo = '$sexo',	fecha_nac = str_to_date('$fecha_nac_pac', '%d/%m/%Y'),	edad='$edad_pac',	telefono_paciente = '$tel_paciente'";		if(mysql_query($insert_paciente)){		$response["status_paciente"] = "success";		$response["mensaje_paciente"] = "success";	}	else{		$response["status_paciente"] = "error";		$response["mensaje_paciente"] = "Error paciente".mysql_error();			}		$id_paciente = mysql_insert_id();	//--------------------------------------------------------------------------------------------------------------	$id_orden = $folio_actual;		$insert_orden="INSERT INTO ordenes 	SET	id_orden = '$id_orden',	fecha_elabora = CURDATE(),	hora_elabora = CURTIME(),	fecha_entrega = str_to_date('$fecha_entrega', '%d/%m/%Y'),	estatus_actual= 'En gabinete',	elabora = '$elabora',	id_doctor = '$id_doctor',	id_paciente = '$id_paciente',	anticipo = '$anticipo',	importe_total_orden = '$importe_total',	importe_total_letra = '$importe_total_letra',	zona_origen = '$zona_origen',	modo_entrega = '$modo_entrega',	restante = '$restante',	efectivo = '$efectivo',	tarjeta = '$tarjeta',	medio_pago = '$medio_pago',	recibo_honorarios = $recibo_honorarios,	sucursal = '$sucursal'";		if(mysql_query($insert_orden)){		//$id_orden = mysql_insert_id();				$response["status_orden"] = "success";		$response["mensaje_orden"] = "Orden Guardada Correctamente";		$response["id_orden"] =$id_orden ;						$nuevo_folio =  actualizarFolio($id_orden);				$update_folio="UPDATE folios		SET folio_actual = '$nuevo_folio'		 WHERE tipo_folio = '$tipo_folio'";					$response["query_folio"] = "$update_folio";				if (mysql_query($update_folio)){			//$response["folio_actual"] = "$guia";			$response["nuevo_folio"] = "$nuevo_folio";			$response["estatus_folio"] = "success";			$response["mensaje_folio"] = "Folio Actualizado";		}		else{			$response["estatus_folio"] = "error";			$response["mensaje_folio"] = mysql_error();		}					}	else{		$response["status_orden"] = "error";		$response["mensaje_orden"] = "Error en  $insert_orden".mysql_error();			}					foreach($estudios as $key => $value){						if($value){			$insert_detalle ="INSERT INTO detalle_orden			SET id_orden='$id_orden',			id_estudio = '$key'";			mysql_query($insert_detalle) or die("Error al insertar detalle: $insert_detalle ".mysql_error());						if(mysqli_query($link_remote, $insert_detalle)){					$response["insert_detalle_remote_estatus"] = "success"; 					$response["insert_detalle_remote_mensaje"] = "Detalle Insertado remotamente"; 			}			else{					$response["insert_detalle_remote_estatus"] = "error";					$response["insert_detalle_remote_mensaje"] = 	"Error en insert_detalle remote: $insert_detalle ".mysqli_error($link_remote);							}				}	}		if(isset($_POST["adicionales"])){		$adicionales = $_POST["adicionales"];		//$response["adicionales"] = var_dump($adicionales );				foreach($adicionales as $key => $value){								$insert_detalle ="INSERT INTO detalle_orden			SET id_orden='$id_orden',			id_estudio = '$value'";						mysql_query($insert_detalle) or die("Error al insertar adicionales: $insert_detalle ".mysql_error());						}	}				$response["mensaje_server"] = "Orden Guardada en Servidor:" . $_POST["server"];		echo json_encode($response);			FUNCTION actualizarFolio($folio_actual){		$str = $folio_actual;		$folio = preg_replace('/\D/', '', $str);		$serie= $folio_actual[0];		$folio_nuevo = $folio + 1;				return $serie.$folio_nuevo;			}?>